DROP TABLE A2ERROREVENT;
CREATE TABLE A2ERROREVENT (
ERRORID       INTEGER,
SOURCE_ROWID  ROWID,
SOURCE_TABLE  VARCHAR2(30),
ERRORCODE     INTEGER,
FILTERID      INTEGER,
DATETIME      DATE,
ACTION        VARCHAR2(6),
CONSTRAINT    ERROREVENTACTION
CHECK (ACTION IN ('SKIP','MODIFY'))
);

DROP SEQUENCE A2ERROR_SEQ;
CREATE SEQUENCE A2ERROR_SEQ;

DROP TABLE DWPROD;
DROP TABLE DWCUST;
DROP TABLE DWSALE;

CREATE TABLE DWPROD (
DWPRODID      NUMBER(38),
DWSOURCETABLE VARCHAR2(30),
DWSOURCEID    INTEGER,
PRODNAME      VARCHAR2(100),
PRODCATNAME   VARCHAR2(38),
PRODMANUNAME  VARCHAR2(38),
PRODSHIPNAME  VARCHAR2(38),
PRIMARY KEY (DWPRODID)
);

DROP SEQUENCE DWPROD_SEQ;
CREATE SEQUENCE DWPROD_SEQ;

CREATE TABLE DWCUST  (
DWCUSTID        NUMBER(38),
DWSOURCEIDBRIS  INTEGER,
DWSOURCEIDMELB  INTEGER,
FIRSTNAME       VARCHAR2(30),
SURNAME         VARCHAR2(30),
GENDER          VARCHAR2(10),
PHONE           VARCHAR2(20),
POSTCODE        NUMBER(4),
CITY            VARCHAR(50),
STATE           VARCHAR2(10),
CUSTCATCODE     NUMBER(38),
PRIMARY KEY (DWCUSTID)
);

DROP SEQUENCE DWCUST_SEQ;
CREATE SEQUENCE DWCUST_SEQ;

CREATE TABLE DWSALE  (
DWSALEID        NUMBER(38),
DWCUSTID        NUMBER(38),
DWPRODID        NUMBER(38),
DWSOURCEIDBRIS  INTEGER,
DWSOURCEIDMELB  INTEGER,
QTY             NUMBER(2),
SALE_DWDATEID   NUMBER(38),
SHIP_DWDATEID   NUMBER(38),
SALEPRICE       NUMBER(7,2),
PRIMARY KEY (DWSALEID)
);

DROP SEQUENCE DWSALE_SEQ;
CREATE SEQUENCE DWSALE_SEQ;

DROP TABLE GENDERSPELLING; 

CREATE TABLE GENDERSPELLING (
INVALID_VALUE VARCHAR2(10),
NEW_VALUE VARCHAR2(10)
);

INSERT INTO GENDERSPELLING VALUES ('MAIL', 'M');
INSERT INTO GENDERSPELLING VALUES ('WOMAN', 'F');
INSERT INTO GENDERSPELLING VALUES ('FEM', 'F');
INSERT INTO GENDERSPELLING VALUES ('FEMALE', 'F');
INSERT INTO GENDERSPELLING VALUES ('MALE', 'M');
INSERT INTO GENDERSPELLING VALUES ('GENTLEMAN', 'M');
INSERT INTO GENDERSPELLING VALUES ('MM', 'M');
INSERT INTO GENDERSPELLING VALUES ('FF', 'F');
INSERT INTO GENDERSPELLING VALUES ('FEMAIL', 'F');


/*PART 2. PRODUCT TRANSFER
Task 2.1
filter #1 
a
*/
insert into A2ERROREVENT(ERRORID, SOURCE_ROWID,SOURCE_TABLE,ERRORCODE,FILTERID,DATETIME,ACTION)

select A2ERROR_SEQ.NEXTVAL,ROWID,'A2PRODUCT',105,1,SYSDATE,'SKIP' from A2PRODUCT where PRODNAME is null;
/*
b
*/
select * from A2ERROREVENT;

/*
TASK 2.2 
    FILTET #2
a
*/

insert into A2ERROREVENT(ERRORID, SOURCE_ROWID,SOURCE_TABLE,ERRORCODE,FILTERID,DATETIME,ACTION)

select A2ERROR_SEQ.NEXTVAL,ROWID,'A2PRODUCT',131,2,SYSDATE,'MODIFY' from A2PRODUCT where MANUFACTURERCODE is null;

/*
PART b  TESTING 
*/

SELECT * from A2ERROREVENT;

/*
TASK 2.3 
    FILTET #3
a
*/

insert into A2ERROREVENT(ERRORID, SOURCE_ROWID,SOURCE_TABLE,ERRORCODE,FILTERID,DATETIME,ACTION)

select A2ERROR_SEQ.NEXTVAL,ROWID,'A2PRODUCT',146,3,SYSDATE,'MODIFY' from A2PRODUCT 
where A2PRODUCT.PRODCATEGORY NOT IN
(SELECT A2PRODCATEGORY.PRODUCTCATEGORY FROM A2PRODCATEGORY) or
(PRODCATEGORY is null);

/*
PART b  TESTING 
*/
SELECT * from A2ERROREVENT;

/*
TASK 2.4.3 

a
*/

insert into DWPROD(DWPRODID, DWSOURCETABLE,DWSOURCEID,PRODNAME,PRODCATNAME,PRODMANUNAME,PRODSHIPNAME)
select DWPROD_SEQ.NEXTVAL,'A2PRODUCT',a2product.prodid,a2product.prodname,
(SELECT A2PRODCATEGORY.PRODUCTCATEGORY FROM A2PRODCATEGORY 
WHERE A2PRODCATEGORY.PRODUCTCATEGORY = A2PRODUCT.PRODCATEGORY),
(SELECT MANUNAME FROM A2MANUFACTURER WHERE MANUCODE = A2PRODUCT.MANUFACTURERCODE),
(SELECT DESCRIPTION FROM A2SHIPPING WHERE SHIPPINGCODE = A2PRODUCT.SHIPPINGCODE)
From A2PRODUCT Where ROWID NOT IN
( SELECT SOURCE_ROWID FROM A2ERROREVENT ); 


/*
  TESTING 
*/
SELECT * from DWPROD;

/*
TASK 2.4.4 

B
*/

insert into DWPROD(DWPRODID, DWSOURCETABLE,DWSOURCEID,PRODNAME,PRODCATNAME,PRODMANUNAME,PRODSHIPNAME)

select DWPROD_SEQ.NEXTVAL,'A2PRODUCT',a2product.prodid,a2product.prodname,

(SELECT A2PRODCATEGORY.PRODUCTCATEGORY FROM A2PRODCATEGORY 
WHERE A2PRODCATEGORY.PRODUCTCATEGORY = A2PRODUCT.PRODCATEGORY),
'UNKNOWN',
(SELECT DESCRIPTION FROM A2SHIPPING WHERE SHIPPINGCODE = A2PRODUCT.SHIPPINGCODE)
FROM A2PRODUCT WHERE A2PRODUCT.ROWID IN
(SELECT SOURCE_ROWID FROM A2ERROREVENT WHERE A2ERROREVENT.FILTERID=2);

/*
  TESTING 
*/
SELECT * from DWPROD;



/*
TASK 2.4.5 

C
*/
insert into DWPROD(DWPRODID, DWSOURCETABLE,DWSOURCEID,PRODNAME,PRODCATNAME,PRODMANUNAME,PRODSHIPNAME)

select DWPROD_SEQ.NEXTVAL,'A2PRODUCT',a2product.prodid,a2product.prodname,

(SELECT A2PRODCATEGORY.PRODUCTCATEGORY FROM A2PRODCATEGORY 
WHERE A2PRODCATEGORY.PRODUCTCATEGORY = A2PRODUCT.PRODCATEGORY),
'UNKNOWN',
(SELECT DESCRIPTION FROM A2SHIPPING WHERE SHIPPINGCODE = A2PRODUCT.SHIPPINGCODE)
FROM A2PRODUCT WHERE A2PRODUCT.ROWID IN
(SELECT SOURCE_ROWID FROM A2ERROREVENT WHERE A2ERROREVENT.FILTERID=3);


/*
  TESTING 
*/
SELECT * from DWPROD;

/*PART 3. CUSTOMER BRISBANE TRANSFER
Task 3.1
filter #4 
a
*/

insert into A2ERROREVENT(ERRORID, SOURCE_ROWID,SOURCE_TABLE,ERRORCODE,FILTERID,DATETIME,ACTION)

select A2ERROR_SEQ.NEXTVAL,ROWID,'A2CUSTBRIS',167,4,SYSDATE,'MODIFY' from A2CUSTBRIS WHERE

NOT EXISTS (SELECT CUSTCATCODE FROM A2CUSTCATEGORY where A2CUSTBRIS.CUSTCATCODE = A2CUSTCATEGORY.CUSTCATCODE );



/*
PART B
  TESTING 
*/

SELECT * from A2ERROREVENT;


/*
Task 3.2
filter #5 
a
*/

insert into A2ERROREVENT(ERRORID, SOURCE_ROWID,SOURCE_TABLE,ERRORCODE,FILTERID,DATETIME,ACTION)

select A2ERROR_SEQ.NEXTVAL,ROWID,'A2CUSTBRIS',194,5,SYSDATE,'MODIFY' from A2CUSTBRIS 

 WHERE PHONE LIKE '%-%' OR PHONE LIKE '% %';

/*
PART B
  TESTING 
*/

SELECT * from A2ERROREVENT;


/*
Task 3.3
filter #6 
a
*/

insert into A2ERROREVENT(ERRORID, SOURCE_ROWID,SOURCE_TABLE,ERRORCODE,FILTERID,DATETIME,ACTION)

select A2ERROR_SEQ.NEXTVAL,ROWID,'A2CUSTBRIS',219,6,SYSDATE,'MODIFY' from A2CUSTBRIS 

 WHERE PHONE NOT LIKE '%-%' AND PHONE NOT LIKE '% %' AND length(phone)!=10;
 

/*
PART B
  TESTING 
*/

SELECT * from A2ERROREVENT;


/*
Task 3.4
filter #7 
a
*/

insert into A2ERROREVENT(ERRORID, SOURCE_ROWID,SOURCE_TABLE,ERRORCODE,FILTERID,DATETIME,ACTION)

select A2ERROR_SEQ.NEXTVAL,ROWID,'A2CUSTBRIS',227,7,SYSDATE,'MODIFY' from A2CUSTBRIS 

WHERE GENDER NOT IN ('M','F','m','f') OR GENDER is null;



/*
PART B
  TESTING 
*/

SELECT * from A2ERROREVENT;


